{% load static %}
<!--Para render-->

<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Bares - Dashboard</title>
  <!-- Rutas locales eliminadas, solo usar static -->
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap"
      rel="stylesheet"
    />
  <link rel="stylesheet" href="{% static 'bares_snacks/css/bares.css' %}" />
  <link rel="stylesheet" href="{% static 'bares_snacks/css/producto.css' %}" />
  <link rel="stylesheet" href="{% static 'bares_snacks/css/ordenes.css' %}" />
  <link rel="stylesheet" href="{% static 'bares_snacks/css/pedidos.css' %}" />
    <link
      rel="stylesheet"
      href="{% static 'bares_snacks/css/promociones.css' %}"
    />
    <link
      rel="stylesheet"
      href="{% static 'bares_snacks/css/sidebar.css' %}"
    />
    <script src="{% static 'bares_snacks/js/miniMenu.js' %}"></script>
    <script src="{% static 'bares_snacks/js/pedidos.js' %}"></script>
  <script src="{% static 'bares_snacks/js/ordenes.js' %}"></script>
    <script src="{% static 'bares_snacks/js/productos.js' %}"></script>
    <script src="{% static 'bares_snacks/js/promociones.js' %}"></script>
  </head>
  <body>
    <div class="dashboard-container">
      <!-- Sidebar -->
      <aside class="sidebar">
        <div class="sidebar-header">
          <div class="logo" onclick="toggleSidebar()" style="cursor: pointer">
            <img
              src="{% static 'svg/logo/logo_Blanco.svg' %}"
              alt="Logo"
              class="logo-icon"
            />
          </div>
        </div>

        <nav class="sidebar-nav">
          <ul class="nav-list">
            <li class="nav-item">
              <a href="/" class="nav-link">
                <span class="nav-text">Inicio</span>
              </a>
            </li>
            <li class="nav-item">
              <a href="{% url 'gestion_crucero' crucero.id %}" class="nav-link">
                <span class="nav-text">Dashboard</span>
              </a>
            </li>
            <li class="nav-item">
              <a href="#" class="nav-link">
                <span class="nav-text">Ventas</span>
              </a>
            </li>
            <li class="nav-item">
              <a href="#" class="nav-link">
                <span class="nav-text">Reservas</span>
              </a>
            </li>
            <li class="nav-item">
              <a href="#" class="nav-link">
                <span class="nav-text">Restaurante</span>
              </a>
            </li>
            <li class="nav-item active">
              <a href="{% url 'bares' crucero.id %}" class="nav-link">
                <span class="nav-text">Bares</span>
              </a>
            </li>
            <li class="nav-item">
              <a href="{% url 'entretenimiento:entretenimiento' crucero.id %}" class="nav-link">
                <span class="nav-text">Entretenimiento</span>
              </a>
            </li>
            <li class="nav-item">
              <a href="#" class="nav-link">
                <span class="nav-text">Compras</span>
              </a>
            </li>
            <li class="nav-item">
              <a href="{% url 'vista_almacen' crucero.id %}" class="nav-link">
                <span class="nav-text">Almacen</span>
              </a>
            </li>
            <li class="nav-item">
              <a href="#" class="nav-link">
                <span class="nav-text">Recursos Humanos</span>
              </a>
            </li>
            <li class="nav-item">
              <a href="#" class="nav-link">
                <span class="nav-text">Servicios Medicos</span>
              </a>
            </li>
            <li class="nav-item">
              <a href="#" class="nav-link">
                <span class="nav-text">Mantenimiento</span>
              </a>
            </li>
          </ul>
        </nav>

        <div class="sidebar-footer">
          <!-- Footer del sidebar -->
        </div>
      </aside>

      <!-- Main Content -->
      <main class="main-content">
        <!-- Header Din√°mico -->
        <section class="dynamic-header" id="dynamic-header">
          <div class="dh-block">
            <span class="dh-label">Barco</span>
            <span class="dh-value">{{ crucero.nombre|default:'Crucero' }}</span>
            <span class="dh-sub">Bar asignado: {{ bar_asignado|default:'Bar Piscina' }}</span>
          </div>
          <div class="dh-block dh-user">
            <span class="dh-label">Usuario</span>
            <span class="dh-value">{{ request.user.username|default:'user' }}</span>
            <span class="dh-sub">{{ request.user.profile.cargo|default:'cargo' }}</span>
          </div>
          <div class="dh-block">
            <span class="dh-label">Pasajeros</span>
            <span class="dh-value">2000 demo</span>
            <span class="dh-sub">Capacidad</span>
          </div>
            <div class="dh-block dh-time">
              <span class="dh-label">Ahora</span>
              <span class="dh-value" id="hora-actual">--:--</span>
              <span class="dh-sub" id="fecha-actual">--/--/----</span>
            </div>
        </section>
        <!-- Mini men√∫ lateral flotante -->
        <nav class="mini-menu">
          <ul>
            <li>
              <a href="#ordenes" class="mini-menu-icon active" title="√ìrdenes">
                <img src="{% static 'svg/dashboard/orden.svg' %}" alt="üçπ" />
              </a>
            </li>
            <li>
              <a href="#pedidos" class="mini-menu-icon" title="Pedidos">
                <img src="{% static 'svg/dashboard/pedido.svg' %}" alt="üö≤" />
              </a>
            </li>
            <li>
              <a href="#productos" class="mini-menu-icon" title="Men√∫">
                <img src="{% static 'svg/dashboard/menu.svg' %}" alt="üçÜ" />
              </a>
            </li>
            <li>
              <a href="#promociones" class="mini-menu-icon" title="Promociones">
                <img src="{% static 'svg/dashboard/promos.svg' %}" alt="‚ûó" />
              </a>
            </li>
            <li>
              <a href="#analisis" class="mini-menu-icon" title="An√°lisis">
                <img src="{% static 'svg/dashboard/analisis.svg' %}" alt="üìö" />
              </a>
            </li>
          </ul>
        </nav>
  <!-- (Header contextual integrado arriba) -->

        <!-- Dashboard Content -->
        <div class="dashboard-content">
          

          <!-- Secciones del mini men√∫ -->
          <section id="ordenes" class="menu-section">
            <!-- M√≥dulo √ìrdenes reiniciado: implementaci√≥n previa eliminada -->
            <div class="ordenes-placeholder" style="text-align:center; padding:48px 12px; color:#64748b; font-size:1.05rem;">
              M√≥dulo de √ìrdenes en reconstrucci√≥n.
            </div>
          </section>
          <section id="pedidos" class="menu-section" style="display: none">
            <button id="btn-abrir-crear-pedido" class="btn-crear-pedido-fab" title="Crear nuevo pedido">+ Pedido</button>
            <h2 style="text-align:center; color:#1e293b; margin-top:60px;">Gesti√≥n de Pedidos</h2>
            <div class="pedidos-explicacion">Registrar ventas (Bar o Camarote). Estados: Pendiente ‚Üí En Proceso ‚Üí Completado. Pendiente modificable, en proceso bloquea edici√≥n, completado pasa a historial.</div>
            <div class="pedidos-paneles">
              <div class="panel-pedidos">
                <h3 class="pedidos-seccion-titulo">Activos</h3>
                <div id="pedidos-lista-activos" class="pedidos-lista" aria-live="polite">
                  <div class="pedidos-empty">No hay pedidos activos.</div>
                </div>
              </div>
              <div class="panel-pedidos">
                <h3 class="pedidos-seccion-titulo">Historial</h3>
                <div id="pedidos-lista-historial" class="pedidos-lista" aria-live="polite">
                  <div class="pedidos-empty">Sin registros en historial.</div>
                </div>
              </div>
            </div>
            <!-- Modal Crear Pedido -->
            <div id="modal-crear-pedido" class="modal-pedido" aria-hidden="true">
              <div class="modal-pedido-dialog">
                <button class="modal-close" id="close-modal-pedido" aria-label="Cerrar">√ó</button>
                <h2 class="modal-title">Crear Pedido</h2>
                <form id="form-crear-pedido" class="form-crear-pedido" autocomplete="off">
                  <div class="form-row fila-2cols">
                    <label>Tipo Consumo
                      <select id="pedido-tipo-consumo" name="tipo_consumo" required>
                        <option value="bar" selected>En Bar / Instalaci√≥n</option>
                        <option value="camarote">En Camarote</option>
                      </select>
                    </label>
                    <div></div>
                  </div>
                  <div class="form-row">
                    <label>Productos Disponibles
                      <select id="pedido-productos" name="productos_ids" multiple size="8" required style="min-height:180px; width:100%;"></select>
                      <small style="font-size:.65rem; color:#64748b; display:block; margin-top:4px;">Mant√©n Ctrl (o Cmd) para seleccionar varios. (Se cargan din√°micamente)</small>
                      <div id="pedido-productos-cantidades" class="productos-cantidades-box" style="margin-top:10px; display:flex; flex-direction:column; gap:6px;"></div>
                      <small style="font-size:.6rem; color:#475569; display:block;">Ajusta cantidades de cada producto abajo. Quita uno con la ‚úï.</small>
                    </label>
                  </div>
                  <div class="form-row fila-2cols">
                    <label>Nombre Cliente (Demo)
                      <input type="text" name="cliente_nombre" id="pedido-cliente-nombre" maxlength="60" placeholder="Nombre del cliente" />
                    </label>
                    <label id="wrapper-instalacion">Instalaci√≥n Entrega
                      <select name="lugarentrega_id" id="pedido-lugarentrega" required>
                        <option value="" selected>Selecciona...</option>
                      </select>
                    </label>
                    <label id="wrapper-habitacion" style="display:none;">Habitaci√≥n
                      <select id="pedido-habitacion" name="habitacion_id">
                        <option value="" selected>Selecciona...</option>
                      </select>
                    </label>
                  </div>
                  <input type="hidden" id="pedido-lugarentrega-nombre" name="lugarentrega_nombre" />
                  <input type="hidden" id="pedido-habitacion-nombre" name="habitacion_nombre" />
                  <div class="form-row fila-3cols">
                    <label>Cliente ID
                      <input type="number" name="cliente_id" id="pedido-cliente" min="1" required placeholder="Ej: 12" />
                    </label>
                    <label>Empleado ID
                      <input type="number" name="empleado_id" id="pedido-empleado" min="1" required placeholder="Ej: 3" />
                    </label>
                    
                  </div>
                  <div class="form-row fila-2cols">
                    <div>
                      <label>Resumen de disponibilidad</label>
                      <div id="resumen-disponibilidad" style="font-size:.75rem; color:#334155; background:#f8fafc; border:1px solid #e2e8f0; border-radius:12px; padding:10px; min-height:42px;">
                        <em>(Selecciona productos para ver disponibilidad)</em>
                      </div>
                    </div>
                    <label>Nota / Referencia
                      <input type="text" name="nota" id="pedido-nota" maxlength="60" placeholder="Opcional" />
                    </label>
                  </div>
                  <div class="form-row fila-2cols">
                    <label>Fecha
                      <input type="date" name="fecha" id="pedido-fecha" required />
                    </label>
                    <label>Hora
                      <input type="time" name="hora" id="pedido-hora" required />
                    </label>
                  </div>
                  <div class="form-row acciones">
                    <button type="button" class="btn-secundario" id="cancelar-pedido">Cancelar</button>
                    <button type="submit" class="btn-primario">Guardar</button>
                  </div>
                  <p class="ayuda-form">Luego conectaremos este formulario al modelo <strong>Pedidos</strong> y generaremos Detalles.</p>
                </form>
              </div>
            </div>
            <!-- Modal Cambio Estado -->
            <div id="modal-estado-pedido" class="modal-pedido" aria-hidden="true">
              <div class="modal-pedido-dialog">
                <button class="modal-close" id="close-modal-estado" aria-label="Cerrar">√ó</button>
                <h2 class="modal-title" id="estado-modal-titulo">Modificar Estado</h2>
                <div id="estado-resumen" class="estado-resumen"></div>
                <div class="estado-warning" id="estado-warning"></div>
                <div class="estado-acciones">
                  <button type="button" class="btn-secundario" id="cancelar-estado">Cancelar</button>
                  <button type="button" class="btn-primario" id="confirmar-estado">Confirmar</button>
                </div>
              </div>
            </div>
          </section>
          <section id="productos" class="menu-section" style="display: none">
            <!-- UI exclusiva de productos: s√≥lo visible cuando esta secci√≥n est√° activa -->
            <button id="btn-abrir-crear-producto" class="btn-crear-producto-fab" title="Crear nuevo producto">+ Producto</button>
            <h2 style="text-align: center; color: #1e293b; margin-top:60px;">Gesti√≥n de Men√∫</h2>
            <!-- Filtros combinados plan + categor√≠a -->
            <div id="plan-filtros" class="plan-filtros" aria-label="Filtro por plan y categor√≠a" aria-hidden="true">
              <div class="filtro-categoria-select-wrapper inline">
                <label for="filtro-categoria-select" class="filtro-categoria-label">Categor√≠a</label>
                <select id="filtro-categoria-select" class="filtro-categoria-select" aria-label="Filtrar por categor√≠a">
                  <option value="__ALL__">Todas</option>
                </select>
              </div>
              <button type="button" class="plan-filter-btn activo" data-plan="todos">Todos los planes</button>
              <button type="button" class="plan-filter-btn" data-plan="all_inclusive">All Inclusive</button>
              <button type="button" class="plan-filter-btn" data-plan="premium">Premium</button>
            </div>
            <!-- Contenedor de categor√≠as y mensaje vac√≠o -->
            <div id="productos-contenedor" class="productos-contenedor">
              <div id="productos-empty" class="productos-empty">No hay productos.</div>
            </div>
            <!-- Modal ver m√°s (detalles receta) -->
            <div id="modal-detalle-producto" class="modal-producto" aria-hidden="true">
              <div class="modal-producto-dialog">
                <button class="modal-close" id="close-modal-detalle" aria-label="Cerrar">√ó</button>
                <h2 class="modal-title" id="detalle-producto-titulo">Detalle del Producto</h2>
                <div id="detalle-producto-body" class="detalle-producto-body"></div>
              </div>
            </div>
          </section>
          <section id="promociones" class="menu-section" style="display: none">
            <h2 style="text-align: center; color: #1e293b">
              Est√°s en el men√∫ de Promociones
            </h2>
            <div class="promociones-section">
              <!-- D√≠a actual -->
              <div id="promocion-dia-actual" class="promo-dia-actual"></div>
              <!-- Todas las promociones -->
              <!--Para cargar las imagenes de las promos-->
              {% load static %}
              <script>
                const promoImages = {
                  "2x1 en Cervezas": "{% static 'svg/promos/two-mugs.svg' %}",
                  "Martes de Tacos": "{% static 'svg/promos/taco.svg' %}",
                  "Jarra de Cerveza a Precio Especial":
                    "{% static 'svg/promos/beer.svg' %}",
                  "C√≥cteles a Precio de Happy Hour toda la noche":
                    "{% static 'svg/promos/cocktail-glass.svg' %}",
                  "Brunch con Mimosa o Bloody Mary incluido":
                    "{% static 'svg/promos/tropical-drinks.svg' %}",
                  "Lunes de Trabajo": "{% static 'svg/promos/coffee.svg' %}",
                  "Mi√©rcoles de Dulce": "{% static 'svg/promos/bagel.svg' %}",
                  "Viernes de Tarde":
                    "{% static 'svg/promos/bubble-tea.svg' %}",
                };
              </script>
              <div class="promociones-lista">
                <h3 class="promo-list-title">Promociones Especiales por D√≠a</h3>
                <ul id="lista-promociones" class="promo-list"></ul>
              </div>
            </div>
          </section>
          <section id="analisis" class="menu-section" style="display: none">
            <h2 style="text-align: center; color: #1e293b">
              Est√°s en el men√∫ de An√°lisis
            </h2>
          </section>
          <!-- Modal para ver detalles del pedido tipo factura (debe estar fuera de las secciones) -->
          <div id="modal-detalle-pedido" class="modal" style="display: none">
            <div class="modal-content" id="detalle-pedido-content">
              <!-- El contenido se genera por JS -->
            </div>
          </div>
          <!-- Modal crear producto -->
          <div id="modal-crear-producto" class="modal-producto" aria-hidden="true">
            <div class="modal-producto-dialog">
              <button class="modal-close" id="close-modal-crear" aria-label="Cerrar">√ó</button>
              <h2 class="modal-title">Crear Producto</h2>
              <form id="form-crear-producto" class="form-crear-producto" autocomplete="off">
                <div class="form-row">

                  <label>Nombre (m√°x 30)
                    <input type="text" name="nombre" id="nombre-producto" maxlength="30" required placeholder="Ej: Mojito Cl√°sico" />
                  </label>
                </div>
                <div class="form-row fila-2cols">
                  <label>Categor√≠a (Filtro)
                    <select name="categoria_filtro" id="categoria-filtro-select" required>
                      <option value="">Selecciona</option>
                      <option value="Comida">Comida</option>
                      <option value="Cafe / Barista">Cafe / Barista</option>
                      <option value="Snacks">Snacks</option>
                      <option value="Bebidas">Bebidas</option>
                      <option value="Cocteles">Cocteles</option>
                      <option value="All inclusive">All inclusive</option>
                      <option value="Premium">Premium</option>
                    </select>
                  </label>
                  <label>Tipo (Almac√©n)
                    <select name="tipo_almacen" id="tipo-almacen-select" required></select>
                  </label>
                </div>
                <div class="form-row fila-2cols">
                  <label>Subtipo (Almac√©n)
                    <select name="subtipo_almacen" id="subtipo-almacen-select" required></select>
                  </label>
                  <label>Plan
                    <select name="plan" id="plan-producto" required>
                      <option value="all_inclusive">All Inclusive</option>
                      <option value="premium">Premium</option>
                    </select>
                  </label>
                </div>
                <div class="form-row fila-2cols">
                  <label id="precio-wrapper">Precio Venta
                    <input type="number" step="0.01" min="0" name="precio" id="precio-input" placeholder="0.00" />
                    <small style="font-size:.6rem; color:#64748b; display:block; margin-top:4px;">Si el plan es All Inclusive y dejas 0 se considera sin costo.</small>
                  </label>
                </div>
                <div class="form-row">
                  <label>Ingredientes (selecciona para agregar)
                    <select name="ingredientes" id="ingredientes-select" multiple size="6"></select>
                  </label>
                  <div id="ingredientes-tags" class="ingredientes-tags" aria-live="polite"></div>
                </div>
                <!-- Tabla din√°mica de ingredientes filtrados por Tipo/Subtipo -->
                <div class="form-row">
                  <div id="ingredientes-tabla" class="ingredientes-tabla" aria-live="polite" style="width:100%; overflow:auto;">
                    <!-- Se llena por JS con los productos de almac√©n seg√∫n Tipo/Subtipo -->
                  </div>
                </div>
                <div class="form-row">
                  <div id="resumen-creacion-producto" class="resumen-creacion">
                    <h4 class="resumen-title">Resumen preliminar</h4>
                    <ul class="resumen-list" id="resumen-list"></ul>
                  </div>
                </div>
                <div class="form-row acciones">
                  <button type="button" class="btn-secundario" id="cancelar-crear">Cancelar</button>
                  <button type="submit" class="btn-primario">Guardar</button>
                </div>
                <p class="ayuda-form">Verifica el resumen antes de guardar.</p>
              </form>
            </div>
          </div>
        </div>
      </main>
    </div>
  <script>
    // Script hora / fecha din√°mico para header
    (function(){
      const horaEl = document.getElementById('hora-actual');
      const fechaEl = document.getElementById('fecha-actual');
      if(!horaEl || !fechaEl) return;
      const optsFecha = { year:'numeric', month:'short', day:'2-digit' };
      function pad(n){ return n.toString().padStart(2,'0'); }
      function tick(){
        const now = new Date();
        const h = pad(now.getHours());
        const m = pad(now.getMinutes());
        horaEl.textContent = h+':'+m;
        fechaEl.textContent = now.toLocaleDateString('es-ES', optsFecha).replace(/\./g,'');
      }
      tick();
      setInterval(tick, 60000);
    })();
  </script>
  </body>
  <!-- Rutas locales eliminadas, solo usar static -->
</html>
